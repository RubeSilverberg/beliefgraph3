<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Belief Graph</title>
  <meta name="page-id" content="main-app" />
  <!-- Ensure proper scaling on mobile so detection + layout behave predictably -->
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <!-- Link to your stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- Cytoscape core -->
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
</head>
<body>
  <!-- Page identity / fallback detector -->
  <script>
    (function(){
      const pid = document.querySelector('meta[name="page-id"]').content;
      // Warn if this content is being served for a different expected tool page (likely dev server fallback)
      const p = location.pathname;
      if(pid === 'main-app' && /test-minimal-converter\.html$/.test(p)){
        const warn = document.createElement('div');
        warn.style = 'background:#ffdddd;padding:10px 14px;border:2px solid #cc4444;font:14px/1.4 Arial,sans-serif;margin:0 0 10px 0;';
        warn.innerHTML = '<strong>Warning:</strong> You requested <code>'+p+'</code> but received the main application content. This indicates a dev-server fallback (404 -> index.html).<br/>'+
          'Check the file name spelling (<code>tests/minimal-json/test-minimal-converter.html</code>) or disable history API fallback in Live Server settings.';
        document.body.prepend(warn);
        console.warn('[BeliefGraph] Fallback detected: expected converter page, got main app.');
      }
      // Hash-based helper redirect: visiting /#converter jumps to converter page
      if(pid === 'main-app' && (location.hash === '#converter' || location.search.includes('page=converter'))){
        console.log('[BeliefGraph] Redirecting to minimal converter page via hash/query helper');
        // Use relative path (no leading slash) so it works on GitHub Pages subpath
        location.href = 'tests/minimal-json/test-minimal-converter.html';
        return;
      }
      // Hash helper for design lab (#design-lab or ?page=design-lab)
      if(pid === 'main-app' && (location.hash === '#design-lab' || location.search.includes('page=design-lab'))){
        console.log('[BeliefGraph] Redirecting to design lab via hash/query helper');
        location.href = 'design-lab.html';
        return;
      }
      window.BELIEFGRAPH_PAGE_ID = pid;
      console.log('[BeliefGraph] Page ID:', pid, 'Path:', p);
      // Console helper command (no UI button)
      window.openMinimalConverter = function(){
        window.open('tests/minimal-json/test-minimal-converter.html','_blank');
      };
      // Basic open (will fail if server rewrites all paths to index.html)
      window.openDesignLab = function(){
        window.open('design-lab.html','_blank');
      };
      // Robust open: fetch file then write into a new window so content renders even with SPA-style fallback
      window.openDesignLabForce = async function(){
        try {
          const resp = await fetch('design-lab.html', { cache: 'no-store' });
          const text = await resp.text();
          const w = window.open('about:blank','_blank');
          if(!w){ console.warn('[BeliefGraph] Pop-up blocked.'); return; }
          w.document.open();
          w.document.write(text);
          w.document.close();
          console.log('[BeliefGraph] Design lab injected via fetch fallback.');
        } catch(e){
          console.error('[BeliefGraph] Failed to fetch design-lab.html', e);
        }
      };
      // Inline loader: replace current page DOM with design lab without navigation
      window.loadDesignLabInline = async function(){
        try {
          const resp = await fetch('design-lab.html', { cache: 'no-store' });
          const html = await resp.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          // Preserve current url hash to allow back navigation
          history.replaceState({}, '', '#design-lab-inline');
          document.documentElement.replaceWith(doc.documentElement);
          console.log('[BeliefGraph] Design lab loaded inline.');
        } catch(e){
          console.error('[BeliefGraph] Inline load failed', e);
        }
      };
      console.log('[BeliefGraph] Console helper available: openMinimalConverter()');
      console.log('[BeliefGraph] Additional helpers: openDesignLab(), openDesignLabForce(), loadDesignLabInline()');
    })();
  </script>
  <!-- Mobile device warning (hidden by default; revealed via feature+UA detection) -->
  <div id="mobile-warning" role="alert" style="display:none;position:fixed;top:0;left:0;right:0;background:#fdd;border-bottom:2px solid #d55;padding:12px 16px;font:14px/1.45 Arial,sans-serif;text-align:center;z-index:10000;box-shadow:0 2px 6px rgba(0,0,0,0.15);">
    <strong>Notice:</strong> This tool is not optimized for touch/mobile devices and may not work as intended. Please use a desktop browser for the full experience.
  </div>
  <!-- Cytoscape Canvas -->
  <div id="cy" style="width: 100vw; height: 100vh; top:0; left:0; position:absolute;"></div>

  <!-- Controls -->
  <div id="controls">
    <!-- Primary Action -->
    <div class="control-group primary">
      <button id="btnBayesTime" class="btn-primary">Toggle Bayes Mode</button>
    </div>
    
    <!-- File Operations -->
    <div class="control-group file-ops">
      <button id="btnSaveGraph" class="btn-file">Save</button>
      <button id="btnLoadGraph" class="btn-file">Load</button>
      <button id="btnLoadExample" class="btn-file">Examples</button>
      <button id="btnRestoreAutosave" class="btn-file-secondary">Restore</button>
    </div>
    
    <!-- View Controls -->
    <div class="control-group view">
      <button id="btnResetLayout" class="btn-view">Reset Layout</button>
      <button id="btnClearGraph" class="btn-danger">Clear</button>
    </div>
    
    <!-- Help & Documentation -->
    <div class="control-group help">
      <button id="quick-guide-btn" class="btn-help">Quick Guide</button>
      <button onclick="window.open('https://colab.research.google.com/drive/1SWjr3Fo8Uzb02KErN4BLh3in2_68ozjJ#scrollTo=1jVCcaxG3AT6', '_blank')" class="btn-help">Math Docs</button>
  <button id="btnFeedback" class="btn-help" title="Report bug, ask a question, or send feedback">Feedback / Contact</button>
    </div>
  </div>

  <!-- Custom context menu -->
  <div id="menu">
    <ul id="menu-list"></ul>
  </div>

  <!-- Visual Signals Modal and Content -->
  <div id="visualSignalsModalContent" class="hidden"></div>

  <!-- Bayes Modal and Content -->
<div id="bayes-modal" class="modal hidden">
  <!-- Modal Title -->
  <div class="modal-title">&nbsp;</div>
  
  <!-- Step 1: Baseline -->
  <div id="step-baseline" class="step">
      <div class="step-title">Baseline probability</div>
      <div class="step-sub">Chance <em>[Child]</em> is true if nothing is known about <em>[Parent]</em></div>
      <div id="baseline-input-row">
        <div class="slider-row">
          <input type="range" min="0" max="100" value="50" step="1" id="baseline-slider">
          <span id="baseline-value">50%</span>
        </div>
        <div class="checkbox">
          <label>
            <input type="checkbox" id="inverse-checkbox">
              It's more likely to be true when the second statement is 
  <span class="false-highlight">false</span>
          </label>
        </div>
        <div class="region-label">Allowed: 0%–100%</div>
        <div class="actions">
          <button id="set-baseline-btn">Set baseline</button>
          <button id="cancel-btn-early" style="margin-left:10px;">Cancel</button>
        </div>
      </div>
      <div id="baseline-locked-row" class="hidden locked">
        Set at <span id="baseline-locked-value">50%</span>
        <button id="edit-baseline-btn" style="margin-left:10px;">Edit</button>
        <button id="cancel-btn" style="margin-left:10px;">Cancel</button>
      </div>
    </div>
    <!-- Step 2: Conditional (Parent True/False) -->
    <div id="step-cond-true" class="step hidden">
      <div class="step-title">True conditional</div>
      <div class="step-sub">Chance [Child] is true when [Parent] is <span id="parent-true-word2" style="color: #228B22; font-style: italic; font-weight: bold;">true</span>.</div>
      <div id="cond-true-input-row">
        <div class="slider-row">
          <input type="range" min="0" max="100" value="50" step="1" id="cond-true-slider">
          <span id="cond-true-value">50%</span>
        </div>
        <div class="region-label" id="region-true-label"></div>
        <div class="ratio-label" id="ratio-true-label"></div>
        <div class="warning" id="cond-true-warning"></div>
        <div class="actions">
          <button id="set-cond-true-btn">Set conditional</button>
        </div>
      </div>
      <div id="cond-true-locked-row" class="hidden locked">
        Set at <span id="cond-true-locked-value">50%</span>
        <button id="edit-cond-true-btn" style="margin-left:10px;">Edit</button>
      </div>
    </div>
    <!-- Step 3: Conditional (Parent False/True, inverse) -->
    <div id="step-cond-false" class="step hidden">
      <div class="step-title">False conditional</div>
      <div class="step-sub">Chance [Child] is true when [Parent] is <span id="parent-false-word2" style="color: #ff0000; font-style: italic; font-weight: bold;">false</span>.</div>
      <div id="cond-false-input-row">
        <div class="slider-row">
          <input type="range" min="0" max="100" value="50" step="1" id="cond-false-slider">
          <span id="cond-false-value">50%</span>
        </div>
        <div class="region-label" id="region-false-label"></div>
        <div class="ratio-label" id="ratio-false-label"></div>
        <div class="warning" id="cond-false-warning"></div>
        <div class="actions">
          <button id="set-cond-false-btn">Set conditional</button>
        </div>
      </div>
      <div id="cond-false-locked-row" class="hidden locked">
        Set at <span id="cond-false-locked-value">50%</span>
        <button id="edit-cond-false-btn" style="margin-left:10px;">Edit</button>
      </div>
    </div>
    <!-- Step 4: Summary -->
    <div id="step-summary" class="step hidden">
      <div class="step-title">Summary</div>
      <div class="summary" id="summary-text"></div>
      <div class="actions">
        <button id="ok-btn">OK</button>
      </div>
    </div>
  </div>

  <script type="module" src="script_current.js"></script>
  <script type="module" src="bayes-modal.js"></script>
  <script src="network-logger.js"></script>
  <script>
    // Reusable feedback/contact modal with copy-to-clipboard and mailto fallback
    (function(){
      const EMAIL = 'inferenceenginetool@gmail.com';
      const SUBJECT = 'Belief Graph feedback / question';
      const BODY = 'Hi,\n\nI would like to report a bug / ask a question / share feedback about Belief Graph.\n\nDetails:\n';

      function openFeedbackContact(){
        // Remove any existing modal
        const prev = document.getElementById('feedback-contact-modal');
        if(prev) prev.remove();

        // Overlay
        const overlay = document.createElement('div');
        overlay.id = 'feedback-contact-modal';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.background = 'rgba(0,0,0,0.35)';
        overlay.style.zIndex = 10002;

        // Modal
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.left = '50%';
        modal.style.top = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.background = '#fff';
        modal.style.border = '1px solid #888';
        modal.style.borderRadius = '10px';
        modal.style.padding = '18px 18px 14px 18px';
        modal.style.minWidth = '320px';
        modal.style.maxWidth = '90vw';
        modal.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';

        const title = document.createElement('div');
        title.textContent = 'Feedback / Contact';
        title.style.font = '600 16px Arial, sans-serif';
        title.style.marginBottom = '8px';
        modal.appendChild(title);

        const info = document.createElement('div');
        info.textContent = 'Copy the email, or open your mail app:';
        info.style.fontSize = '13px';
        info.style.color = '#444';
        info.style.marginBottom = '8px';
        modal.appendChild(info);

        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1fr auto';
        row.style.gap = '8px';
        row.style.alignItems = 'center';

        const emailInput = document.createElement('input');
        emailInput.type = 'text';
        emailInput.value = EMAIL;
        emailInput.readOnly = true;
        emailInput.style.padding = '8px';
        emailInput.style.border = '1px solid #bbb';
        emailInput.style.borderRadius = '6px';
        emailInput.style.fontSize = '14px';
        emailInput.style.width = '100%';

        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy';
        copyBtn.style.padding = '8px 10px';
        copyBtn.style.fontSize = '13px';
        copyBtn.onclick = async () => {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(EMAIL);
            } else {
              emailInput.select();
              document.execCommand('copy');
            }
            copyBtn.textContent = 'Copied!';
            setTimeout(()=> copyBtn.textContent = 'Copy', 1200);
          } catch(e) {
            alert('Copy failed. Please select and copy manually.');
          }
        };

        row.appendChild(emailInput);
        row.appendChild(copyBtn);
        modal.appendChild(row);

        const actions = document.createElement('div');
        actions.style.marginTop = '12px';
        actions.style.display = 'flex';
        actions.style.gap = '8px';
        actions.style.flexWrap = 'wrap';

        const openMailBtn = document.createElement('button');
        openMailBtn.textContent = 'Open email app';
        openMailBtn.onclick = () => {
          const subject = encodeURIComponent(SUBJECT);
          const body = encodeURIComponent(BODY);
          window.location.href = `mailto:${EMAIL}?subject=${subject}&body=${body}`;
        };

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.onclick = () => overlay.remove();

        actions.appendChild(openMailBtn);
        actions.appendChild(closeBtn);
        modal.appendChild(actions);

        overlay.appendChild(modal);
        overlay.addEventListener('click', (e) => { if(e.target === overlay) overlay.remove(); });
        document.body.appendChild(overlay);

        // focus for quick selection
        setTimeout(()=> emailInput.focus(), 50);
      }

      window.openFeedbackContact = openFeedbackContact;

      // Hook up Help button
      const btn = document.getElementById('btnFeedback');
      if(btn){
        btn.addEventListener('click', function(){
          openFeedbackContact();
        });
      }
    })();
  </script>
  <!-- Mobile detection script (robust: UA + capability + media queries + size) -->
  <script>
    (function(){
      function adjustLayoutForWarning(){
        const el = document.getElementById('mobile-warning');
        const cy = document.getElementById('cy');
        if(!el || !cy) return;
        if(el.style.display === 'block'){
          const h = el.offsetHeight;
            // push graph below banner
            cy.style.top = h + 'px';
            cy.style.height = 'calc(100vh - ' + h + 'px)';
        }
      }
      function showWarning(){
        const el = document.getElementById('mobile-warning');
        if(el && el.style.display !== 'block'){
          el.style.display = 'block';
          console.warn('[BeliefGraph] Mobile/touch environment detected – showing compatibility warning.');
          // Wait a frame so offsetHeight is correct, then adjust
          requestAnimationFrame(adjustLayoutForWarning);
        } else {
          adjustLayoutForWarning();
        }
      }
      function detectMobile(){
        try {
          const ua = navigator.userAgent || '';
          const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints||0) > 0;
          const mqCoarse = window.matchMedia('(pointer: coarse)').matches;
          const mqNoHover = window.matchMedia('(hover: none)').matches;
          const smallScreen = Math.min(window.innerWidth, window.innerHeight) < 760; // portrait phones
          const uaMobile = /Mobi|Android|iPhone|iPad|iPod|Mobile Safari/i.test(ua);
          // iPadOS desktop-mode Safari sometimes spoofs as Mac; catch via touch + coarse pointer + screen heuristics
          const iPadDesktopMode = hasTouch && mqCoarse && /Macintosh/.test(ua) && ('ontouchend' in document);
          if((uaMobile && hasTouch) || (hasTouch && mqCoarse && mqNoHover) || (hasTouch && smallScreen) || iPadDesktopMode){
            showWarning();
          }
        } catch(e){
          console.warn('[BeliefGraph] Mobile detection error:', e);
        }
      }
      // Run as soon as possible in case DOMContentLoaded already fired by time script executes
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', detectMobile, { once: true });
      } else {
        detectMobile();
      }
      // Re-evaluate once on first resize/orientation change (helpful if loaded in landscape tablet)
      // Re-evaluate & adjust on orientation / resize (debounced minimal)
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(()=>{ detectMobile(); adjustLayoutForWarning(); }, 120);
      });
      window.addEventListener('orientationchange', () => {
        setTimeout(()=>{ detectMobile(); adjustLayoutForWarning(); }, 120);
      });
    })();
  </script>
  <!-- Dev tools are available at tests/dev-tools/ and can be injected from there if needed -->
</body>
</html>
