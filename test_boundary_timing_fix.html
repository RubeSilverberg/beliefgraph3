<!DOCTYPE html>
<html>
<head>
    <title>Boundary & Timing Fix Test</title>
    <script src="https://unpkg.com/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
    <style>
        #cy { width: 800px; height: 400px; border: 1px solid #ddd; }
        #status { margin: 10px 0; font-family: monospace; }
        button { margin: 5px; padding: 8px 16px; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; font-family: monospace; white-space: pre-line; }
    </style>
</head>
<body>
    <h1>Boundary & Timing Fix Test</h1>
    <div id="status">Testing event-based visual updates with no boundary violations</div>
    
    <div>
        <button onclick="testClearGraph()">Test Clear Graph</button>
        <button onclick="testAddNode()">Test Add Node</button>
        <button onclick="testConvergeAll()">Test Convergence</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div id="cy"></div>
    <div id="log" class="log">Test log:\n</div>
    
    <script type="module">
        import { clearGraph, addNote, convergeAll } from './logic.js';
        import { computeVisuals } from './visuals.js';
        
        let eventCount = 0;
        
        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: [
                { data: { id: 'a', label: 'Node A' } },
                { data: { id: 'b', label: 'Node B' } },
                { data: { id: 'ab', source: 'a', target: 'b' } }
            ],
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#666',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'width': '60px',
                        'height': '40px'
                    }
                }
            ],
            layout: { name: 'grid', rows: 2 }
        });
        
        window.cy = cy;
        window.computeVisuals = computeVisuals;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Listen for logic update events to verify they're working
        window.addEventListener('logicUpdate', function(event) {
            eventCount++;
            const { type, data } = event.detail;
            log(`âœ… Received event ${eventCount}: ${type} ${data ? JSON.stringify(data) : ''}`);
        });
        
        window.testClearGraph = function() {
            log('Testing clearGraph() - should trigger graphCleared event...');
            clearGraph();
        };
        
        window.testAddNode = function() {
            log('Testing addNote() - should trigger nodeAdded event...');
            addNote();
        };
        
        window.testConvergeAll = function() {
            log('Testing convergeAll() - should trigger convergenceComplete event...');
            convergeAll({ cy });
        };
        
        window.clearLog = function() {
            eventCount = 0;
            document.getElementById('log').textContent = 'Test log:\n';
        };
        
        // Initial setup
        log('Boundary & timing fix test loaded');
        log('Logic layer now uses events instead of direct visual function calls');
        log('All setTimeout race conditions removed');
    </script>
</body>
</html>
